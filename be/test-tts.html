<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Chatbot Tester</title>
</head>
<body>
<h2>Voice Chatbot Tester</h2>

<button id="recordBtn">üé§ Start Recording</button>
<br><br>

<h3>Transcription:</h3>
<div id="transcript"></div>

<h3>Chatbot Response:</h3>
<div id="answer"></div>

<h3>Audio Output:</h3>
<audio id="audioPlayer" controls></audio>

<script>
let mediaRecorder;
let audioChunks = [];

const recordBtn = document.getElementById("recordBtn");
const transcriptDiv = document.getElementById("transcript");
const answerDiv = document.getElementById("answer");
const audioPlayer = document.getElementById("audioPlayer");

recordBtn.onclick = async () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        // B·∫Øt ƒë·∫ßu ghi √¢m
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

            // 1Ô∏è‚É£ G·ª≠i audio ‚Üí STT
            const sttText = await sendSTT(audioBlob);
            transcriptDiv.innerText = sttText;

            // 2Ô∏è‚É£ G·ª≠i text ‚Üí chatbot
            const botText = await sendChat(sttText);
            answerDiv.innerText = botText;

            // 3Ô∏è‚É£ G·ª≠i botText ‚Üí TTS
            await playTTS(botText);
        };

        mediaRecorder.start();
        recordBtn.innerText = "‚èπ Stop Recording";
    } else {
        // D·ª´ng v√† x·ª≠ l√Ω
        mediaRecorder.stop();
        recordBtn.innerText = "üé§ Start Recording";
    }
};


// --------------- API Calls -----------------

async function sendSTT(audioBlob) {
    const formData = new FormData();
    formData.append("file", audioBlob, "recording.webm");

    const res = await fetch("http://localhost:8000/api/chatbot/stt", {
        method: "POST",
        body: formData
    });

    const json = await res.json();
    return json.transcription || "";
}

async function sendChat(text) {
    const res = await fetch("http://localhost:8000/api/chatbot/word-explain", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: text })
    });

    const json = await res.json();
    return json.response || "";
}

async function playTTS(text) {
    const res = await fetch("http://localhost:8000/api/chatbot/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
    });

    const blob = await res.blob();
    const audioURL = URL.createObjectURL(blob);
    audioPlayer.src = audioURL;
    audioPlayer.play();
}
</script>
</body>
</html>
